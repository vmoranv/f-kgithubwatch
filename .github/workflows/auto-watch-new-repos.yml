name: Auto Watch New Repos

on:
  workflow_dispatch:
    inputs:
      owner:
        description: "GitHub login (default: authenticated user)"
        required: false
        type: string
      owner_type:
        description: "Owner type"
        required: false
        default: "user"
        type: choice
        options:
          - auto
          - user
          - org
      since:
        description: "Watch repos created at/after this UTC timestamp"
        required: false
        default: "2025-04-14T00:00:00Z"
        type: string
      limit:
        description: "Max repos to scan (1-10000)"
        required: false
        default: "1000"
        type: string

jobs:
  auto-watch:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Require classic PAT
        env:
          WATCH_PAT: ${{ secrets.WATCH_PAT }}
        run: |
          if [ -z "${WATCH_PAT}" ]; then
            echo "Missing WATCH_PAT secret."
            echo "Use a classic PAT. Default GITHUB_TOKEN will not work for subscription endpoint."
            exit 1
          fi

      - name: Sync watch subscriptions
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.WATCH_PAT }}
        run: |
          $owner = "${{ github.event.inputs.owner }}"
          if ([string]::IsNullOrWhiteSpace($owner)) { $owner = $null }

          $ownerType = "${{ github.event.inputs.owner_type }}"
          if ([string]::IsNullOrWhiteSpace($ownerType)) { $ownerType = "auto" }

          $sinceRaw = "${{ github.event.inputs.since }}"
          if ([string]::IsNullOrWhiteSpace($sinceRaw)) { $sinceRaw = "2025-04-14T00:00:00Z" }
          $since = [DateTime]::Parse($sinceRaw).ToUniversalTime()

          $limitRaw = "${{ github.event.inputs.limit }}"
          if ([string]::IsNullOrWhiteSpace($limitRaw)) { $limitRaw = "1000" }
          $limit = [int]$limitRaw

          $scriptArgs = @{
            OwnerType = $ownerType
            Since = $since
            Limit = $limit
          }

          if ($owner) {
            $scriptArgs.Owner = $owner
          }

          ./scripts/watch-recent-repos.ps1 @scriptArgs
